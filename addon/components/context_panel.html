<div class="card">
  <h2 class="card-title">Document Context</h2>
  <button class="refresh-btn" onclick="refreshContext()">Extract Context with AI</button>

  <div id="context-results" class="context-results">
    <p><em>Loading context...</em></p>
  </div>
</div>

<script>
  let currentContext = {
    definedTerms: [],
    parties: { partyA: "", partyB: "" },
    jurisdiction: "",
    docType: ""
  };

  async function refreshContext() {
    document.getElementById('context-results').innerHTML = "<p>Parsing document with AI...</p>";
    try {
      const response = await google.script.run.withSuccessHandler(renderContext).runExtractContext();
      console.log("Context extraction response:", response);
    } catch (err) {
      document.getElementById('context-results').innerHTML = `<p>Error: ${err}</p>`;
    }
  }

  function renderContext(response) {
    if (!response || response.success === false) {
      document.getElementById('context-results').innerHTML = `<p>Error: ${response?.error || 'Unknown error'}</p>`;
      return;
    }

    // Update current context with response data
    currentContext = {
      definedTerms: response.data?.definedTerms || [],
      parties: response.data?.parties || { partyA: "", partyB: "" },
      jurisdiction: response.data?.jurisdiction || "",
      docType: response.data?.docType || ""
    };

    renderEditableContext();
  }

  function renderEditableContext() {
    let html = '<form id="context-form">';

    // Defined Terms Section
    html += '<h3>Defined Terms</h3>';
    html += '<div id="defined-terms-container">';
    currentContext.definedTerms.forEach((term, index) => {
      html += renderDefinedTerm(term, index);
    });
    html += '</div>';
    html += '<button type="button" onclick="addDefinedTerm()">+ Add Term</button>';

    // Parties Section
    html += '<h3>Parties</h3>';
    html += '<div>';
    html += `<input type="text" id="partyA" placeholder="First Party" value="${escapeHtml(currentContext.parties.partyA || '')}" onchange="updateContext()">`;
    html += ' ↔ ';
    html += `<input type="text" id="partyB" placeholder="Second Party" value="${escapeHtml(currentContext.parties.partyB || '')}" onchange="updateContext()">`;
    html += '</div>';

    // Jurisdiction Section
    html += '<h3>Jurisdiction</h3>';
    html += `<input type="text" id="jurisdiction" placeholder="e.g., Delaware" value="${escapeHtml(currentContext.jurisdiction || '')}" onchange="updateContext()">`;

    // Document Type Section
    html += '<h3>Document Type</h3>';
    html += `<input type="text" id="docType" placeholder="e.g., Service Agreement" value="${escapeHtml(currentContext.docType || '')}" onchange="updateContext()">`;

    html += '<br><br>';
    html += '<button type="button" onclick="saveContext()">Save Context</button>';
    html += '</form>';

    document.getElementById('context-results').innerHTML = html;
  }

  function renderDefinedTerm(term, index) {
    return `
      <div class="defined-term" style="margin-bottom: 10px;">
        <input type="text" 
               id="term-${index}" 
               placeholder="Term" 
               value="${escapeHtml(term.term || '')}" 
               onchange="updateDefinedTerm(${index}, 'term', this.value)"
               style="width: 100px;">
        : 
        <input type="text" 
               id="definition-${index}" 
               placeholder="Definition" 
               value="${escapeHtml(term.definition || '')}" 
               onchange="updateDefinedTerm(${index}, 'definition', this.value)"
               style="width: 300px;">
        <button type="button" onclick="removeDefinedTerm(${index})">×</button>
      </div>
    `;
  }

  function addDefinedTerm() {
    currentContext.definedTerms.push({ term: "", definition: "" });
    renderEditableContext();
  }

  function removeDefinedTerm(index) {
    currentContext.definedTerms.splice(index, 1);
    renderEditableContext();
  }

  function updateDefinedTerm(index, field, value) {
    currentContext.definedTerms[index][field] = value;
  }

  function updateContext() {
    currentContext.parties.partyA = document.getElementById('partyA').value;
    currentContext.parties.partyB = document.getElementById('partyB').value;
    currentContext.jurisdiction = document.getElementById('jurisdiction').value;
    currentContext.docType = document.getElementById('docType').value;
  }

  function saveContext() {
    updateContext();
    console.log("Saved context:", currentContext);
    // Store in a global variable that can be accessed by the review function
    window.documentContext = currentContext;
    alert("Context saved! It will be used in the next AI review.");
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Auto-load context on first open
  refreshContext();
</script>
